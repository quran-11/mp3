<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quran Player - Smart Mode</title>
  <style>
    img {
      max-width: 100%;
      height: auto;
      border: 2px solid #444;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Quran Page Player (604 Pages)</h2>

  <label for="start-page">Start from page (1–604):</label>
  <input type="number" id="start-page" value="1" min="1" max="604"><br><br>

  <label for="interval">Time between plays (in minutes):</label>
  <input type="number" id="interval" value="6" min="1"><br><br>

  <label for="repeat-count">Repeat each page how many times:</label>
  <input type="number" id="repeat-count" value="1" min="1"><br><br>

  <button onclick="startPlayer()">Start</button>
  <button onclick="togglePause()" id="pause-btn" disabled>Pause</button>

  <p id="status">Status: Not started</p>
  <p id="countdown">Next play in: --:--</p>

  <audio id="quran-audio" controls></audio><br>
  <img id="page-image" alt="Quran Page" src="">

  <script>
    const audio = document.getElementById('quran-audio');
    const status = document.getElementById('status');
    const countdown = document.getElementById('countdown');
    const pageImage = document.getElementById('page-image');
    const pauseBtn = document.getElementById('pause-btn');

    let page = 1;
    let intervalMinutes = 6;
    let repeatCount = 1;
    let currentRepeat = 0;
    let nextPlayTimer;
    let countdownTimer;
    let timeLeft = 0;
    let isPaused = false;
    let useAudioEndMode = false;

    function pad(num) {
      return num.toString().padStart(3, '0');
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function updateCountdown() {
      if (!isPaused && !useAudioEndMode) {
        if (timeLeft > 0) {
          timeLeft--;
        }
        countdown.textContent = "Next play in: " + formatTime(timeLeft);
      } else if (useAudioEndMode) {
        countdown.textContent = "Next play after audio ends";
      } else {
        countdown.textContent = "--:--";
      }
    }

    function playPage() {
      const pageStr = pad(page);
      const audioUrl = 'https://ia801409.us.archive.org/27/items/quran-604--part-safa7aat-quran-32kb-high-quality-604-part-by-mostafa-esma3il-m/' + pageStr + '.mp3';
      const imageUrl = 'https://ia801504.us.archive.org/24/items/606_20250214/' + pageStr + '.png';

      audio.src = audioUrl;
      audio.load();

      if (!isPaused) {
        audio.play();
      }

      pageImage.src = imageUrl;
      pageImage.alt = `Quran Page ${page}`;
      status.textContent = `Status: Playing page ${page}, repetition ${currentRepeat + 1} of ${repeatCount}`;

      if (useAudioEndMode && !isPaused) {
        audio.onended = () => {
          currentRepeat++;
          if (currentRepeat >= repeatCount) {
            page = (page % 604) + 1;
            currentRepeat = 0;
          }
          playPage();
        };
      } else if (!useAudioEndMode) {
        currentRepeat++;
        if (currentRepeat >= repeatCount) {
          page = (page % 604) + 1;
          currentRepeat = 0;
        }
        timeLeft = intervalMinutes * 60;
      }
    }

    function startPlayer() {
      clearInterval(nextPlayTimer);
      clearInterval(countdownTimer);
      audio.onended = null;

      page = parseInt(document.getElementById('start-page').value) || 1;
      intervalMinutes = parseInt(document.getElementById('interval').value) || 6;
      repeatCount = parseInt(document.getElementById('repeat-count').value) || 1;
      currentRepeat = 0;
      isPaused = false;
      pauseBtn.disabled = false;
      pauseBtn.textContent = "Pause";
      useAudioEndMode = intervalMinutes === 3;

      playPage();

      countdownTimer = setInterval(updateCountdown, 1000);

      if (!useAudioEndMode) {
        timeLeft = intervalMinutes * 60;
        nextPlayTimer = setInterval(playPage, intervalMinutes * 60 * 1000);
      }
    }

    function togglePause() {
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? "Resume" : "Pause";

      if (isPaused) {
        audio.pause();
      } else {
        audio.play();
      }
    }

    // ✅ Image click navigation while paused
    pageImage.addEventListener('mousedown', (e) => {
      if (!isPaused) return;
      e.preventDefault();

      if (e.button === 0) {
        // Left click: next page
        page = (page % 604) + 1;
      } else if (e.button === 2) {
        // Right click: previous page
        page = (page - 2 + 604) % 604 + 1;
      }

      currentRepeat = 0;
      playPage();
    });

    // Prevent right-click context menu on image
    pageImage.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</body>
</html>
